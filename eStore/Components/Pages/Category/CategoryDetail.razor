@page "/categories/{CategoryId:int}"
@rendermode InteractiveServer
@using eStore.Components.Pages.Product

@code {
    [Parameter]
    public int CategoryId { get; set; }

    [Parameter]
    public int ItemsPerPage { get; set; } = 12;

    [Inject] private CategoryService CategoryService { get; set; } = null!;
    [Inject] private ProductService ProductService { get; set; } = null!;

    private CategoryDTO? category;
    private List<ProductDTO> currentPageProducts = new();
    private int currentPage = 1;
    private int totalPages = 1;

    protected override async Task OnParametersSetAsync()
    {
        var categories = await CategoryService.GetAllCategories();
        category = categories.FirstOrDefault(c => c.CategoryId == CategoryId);
        
        if (category != null)
        {
            await LoadProducts();
        }
    }

    private async Task LoadProducts()
    {
        var result = await ProductService.GetActiveProducts(
            currentPage,
            ItemsPerPage,
            ProductSortBy.None,
            null,
            null,
            null,
            new List<int> { CategoryId });

        currentPageProducts = result.Items;
        totalPages = result.TotalPages;
        currentPage = result.CurrentPage;
    }

    private async Task GoToPage(int page)
    {
        if (page < 1 || page > totalPages || page == currentPage)
            return;

        currentPage = page;
        await LoadProducts();
    }
} 

<div class="container mt-4">
    @if (category != null)
    {
        <div class="card mb-4">
            <div class="row g-0">
                <div class="col-md-4">
                    <img src="@(string.IsNullOrEmpty(category.ImageUrl) ? "/images/no_img.jpg" : category.ImageUrl)" 
                         class="img-fluid rounded-start category-img" 
                         alt="@category.CategoryName">
                </div>
                <div class="col-md-8">
                    <div class="card-body">
                        <h2 class="card-title">@category.CategoryName</h2>
                        @if (!string.IsNullOrEmpty(category.Description))
                        {
                            <p class="card-text">@category.Description</p>
                        }
                        <a href="/products?categoryId=@CategoryId" class="btn btn-primary">
                            Xem trong trang sản phẩm để có thêm tùy chọn lọc
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <h3 class="mb-4">Sản phẩm trong danh mục này</h3>
        
        <div class="row row-cols-1 row-cols-md-2 row-cols-xl-3 g-4">
            @foreach (var product in currentPageProducts)
            {
                <div class="col">
                    <ProductCard Product="product" />
                </div>
            }
        </div>

        <Pagination 
            CurrentPage="@currentPage"
            TotalPages="@totalPages"
            OnPageChange="@GoToPage" />
    }
</div>

